{:paths ["." "scripts"]
 :deps {io.github.babashka/sci.nrepl {:mvn/version "0.0.2"}
        org.babashka/cli {:mvn/version "0.2.23"}
        babashka/fs {:mvn/version "0.5.22"}
        org.clojure/data.json {:mvn/version "2.4.0"}}
 :tasks
 {:requires ([babashka.cli :as cli]
             [start-nrepl]
             [tasks])

  browser-nrepl {:doc "Start browser nREPL"
                 :task (start-nrepl/browser-nrepl (cli/parse-opts *command-line-args*
                                                                  {:coerce {:nrepl-port :int
                                                                            :websocket-port :int}}))}

  bundle-scittle {:doc "Download Scittle and nREPL plugin to src/vendor"
                  :task (tasks/bundle-scittle)}

  build {:doc "Build extension for all browsers. Use --dev for dev config. Specify browsers: chrome, firefox, safari"
         :task (apply tasks/build *command-line-args*)}

  build:chrome {:doc "Build extension for Chrome"
                :task (tasks/build "chrome")}

  build:firefox {:doc "Build extension for Firefox"
                 :task (tasks/build "firefox")}

  build:safari {:doc "Build extension for Safari"
                :task (tasks/build "safari")}

  build:dev {:doc "Build extension for all browsers with dev config"
             :task (apply tasks/build "--dev" *command-line-args*)}

  dev {:doc "Start Squint watch and Vite dev server"
       :task (babashka.process/shell "npx squint watch & npx vite")}

  watch {:doc "Start Squint watch mode"
         :task (babashka.process/shell "npx squint watch")}

  squint-nrepl {:doc "Start Squint nREPL server for testing code in Node"
                :task (babashka.process/shell "npx squint nrepl-server :port 1337")}

  ;; Test tasks
  test:watch:squint {:doc "Watch and compile test files"
                     :task (babashka.process/shell "npx squint watch --paths src test --output-dir build/test")}

  test:watch:vitest {:doc "Run Vitest in watch mode"
                     :task (babashka.process/shell "npx vitest")}

  -test:watch {:depends [test:watch:squint test:watch:vitest]}

  test:watch {:doc "Start test watchers (Squint + Vitest) in parallel"
              :task (run '-test:watch {:parallel true})}

  test {:doc "Run tests once"
        :task (do (babashka.process/shell "npx squint compile --paths src test --output-dir build/test")
                  (babashka.process/shell "npx vitest run"))}

  ;; E2E test tasks
  test:e2e:compile {:doc "Compile e2e test files"
                    :task (babashka.process/shell "npx squint compile --paths src e2e --output-dir build/e2e")}

  test:e2e {:doc "Run Playwright E2E tests (builds extension first)"
            :depends [build:chrome test:e2e:compile]
            :task (babashka.process/shell "npx playwright test")}

  test:e2e:headed {:doc "Run Playwright E2E tests with visible browser"
                   :depends [build:chrome test:e2e:compile]
                   :task (babashka.process/shell "npx playwright test --headed")}

  publish {:doc "Publish new version: bump version, update changelog, commit, tag, push"
           :task (tasks/publish)}}}